var width=800,height=600,margin=50,pad=margin/2,radius=10,yFixed=pad+radius,svg=d3.select("body").select("#d3").append("svg").attr("id","arc").attr("width",width).attr("height",height).attr("viewBox",function(){return"0,0,"+width+","+height}),plot=svg.append("g").attr("id","plot").attr("transform","translate("+pad+","+pad+")");
d3.json("data/works-arc.json",function(b){var e=d3.scale.linear().domain([0,b.nodes.length-1]).range([radius,width-margin-radius]);d3.scale.category20();for(var c=[],d=0,g=b.links.length;d<g;d++)c[d]=b.links[d].flights;for(var m=d3.scale.linear().domain(d3.extent(c)).range([2,25]),h=d3.scale.linear().domain(d3.extent(c)).range(["#1F54AD","#20AD1F"]),c=[],d=0,g=b.nodes.length;d<g;d++)for(var f=c[d]=0,n=b.links.length;f<n;f++)b.links[f].source==d&&(c[d]+=b.links[f].flights),b.links[f].target==d&&(c[d]+=
b.links[f].flights);d3.scale.linear().domain(d3.extent(c)).range([30,100]);var k=d3.scale.linear().range([Math.PI/2,3*Math.PI/2]),l=d3.svg.line.radial().interpolate("basis").tension(0).angle(function(a){return k(a)});b.links.forEach(function(a,c){a.source=isNaN(a.source)?a.source:b.nodes[a.source];a.target=isNaN(a.target)?a.target:b.nodes[a.target]});b.nodes.forEach(function(a,b){a.x=e(b);a.y=yFixed});b.nodes.sort(function(a,b){return a.group-b.group});d3.select("#plot").selectAll(".link").data(b.links).enter().append("path").attr("id",
function(a){return a.remark}).attr("class","link").attr("transform",function(a,b){return"translate("+(a.source.x+(a.target.x-a.source.x)/2)+","+yFixed+")"}).attr("d",function(a,b){var c=Math.abs(a.source.x-a.target.x);l.radius(c/2);c=d3.range(0,Math.ceil(c/3));k.domain([0,c.length-1]);return l(c)}).attr("stroke-width",function(a){return m(a.flights)+"px"}).attr("stroke",function(a){return h(a.flights)}).on("mouseover",function(a){arcTooltip(a);d3.select(this).attr("stroke",function(a){return"#333"})}).on("mouseout",
function(a){d3.select("#arcTooltip").remove();d3.select(this).attr("stroke",function(a){return h(a.flights)})});d3.select("#plot").selectAll(".node").data(b.nodes).enter().append("circle").attr("class","node").attr("id",function(a,b){return a.name}).attr("cx",function(a,b){return a.x}).attr("cy",function(a,b){return a.y}).attr("r",function(a,b){return radius}).on("mouseover",function(a){arcFocus(a);d3.select(this).classed("node",!1).classed("nodeFocus",!0).attr("r",function(a){return 1.3*radius})}).on("mouseout",
function(a){arcFocusRemove();d3.select(this).classed("node",!0).classed("nodeFocus",!1).attr("r",function(a){return radius})});d3.select("#plot").selectAll(".label").data(b.nodes).enter().append("text").attr("class","label").text(function(a){return a.name}).attr("text-anchor","middle").attr("x",function(a){return a.x}).attr("y",function(a){return a.y-30})});
function addTooltip(b){var e=parseFloat(b.attr("cx")),c=parseFloat(b.attr("cy")),d=parseFloat(b.attr("r"));b=b.attr("id");c=d3.select("#plot").append("text").text(b).attr("x",e).attr("y",c).attr("dy",2*-d).attr("id","tooltip");b=c.node().getBBox().width/2;0>e-b?(c.attr("text-anchor","start"),c.attr("dx",-d)):e+b>width-margin?(c.attr("text-anchor","end"),c.attr("dx",d)):(c.attr("text-anchor","middle"),c.attr("dx",0))}
function arcTooltip(b){var e=b.source.x+(b.target.x-b.source.x)/2,c=Math.abs(b.source.x-b.target.x)/2;d3.select("#plot").append("text").text(" Total Flights in "+b.remark+" : "+b.flights).attr("x",e).attr("y",c).attr("dy",50).attr("text-anchor","middle").attr("id","arcTooltip")}function arcFocus(b){d3.selectAll(".link").classed("linkGray",!0).forEach(function(e,c){c=0;for(var d=e.length;c<d;c++)-1<e[c].id.indexOf(b.name)&&d3.select("#"+e[c].id).classed("linkGray",!1).classed("linkFocus",!0)})}
function arcFocusRemove(){d3.selectAll(".link").classed("linkFocus",!1).classed("linkGray",!1)};
