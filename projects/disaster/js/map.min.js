function defineCluster(a){var b={};return b.maxClusterRadius=100,b.iconCreateFunction=function(b){var c=b.getChildCount(),d=a;return d+=10>c?"-small":30>c?"-medium":"-large",new L.DivIcon({html:"<div><span>"+c+"</span></div>",className:"marker-cluster "+d,iconSize:new L.Point(40,40)})},L.markerClusterGroup(b)}function defineMarker(a,b,c){var d="<b>事故时间</b>："+a.date+"<br><b>事故地点</b>："+a.place+"<br><b>死亡人数</b>："+a.death+"<br><b>事故原因</b>："+a.desc,e=L.marker(new L.LatLng(a.lat,a.lng),{title:d,icon:c});e.bindPopup(d),b.addLayer(e)}var viewCenter=[34.277799897831,100.9530982792],mapScale=5,minZoom=3,maxZoom=13,mapStyle="http://{s}.tile.osm.org/{z}/{x}/{y}.png",mapAttribution='&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',map=L.map("map").setView(viewCenter,mapScale);L.tileLayer(mapStyle,{attribution:mapAttribution,maxZoom:maxZoom,minZoom:minZoom}).addTo(map);var canvasWidth=300,canvasHeight=440,parseDate=d3.time.format("%Y-%m-%d").parse,yearFormat=d3.time.format("%Y"),yearMonthFormat=d3.time.format("%Y-%m"),heightScale=d3.scale.linear().domain([0,300]).range([0,100]),widthScale=d3.scale.linear().domain([0,60]).range([0,300]);d3.csv("data/geo_disaster.csv",function(a){var b=L.Icon.extend({options:{iconSize:[30,40],iconAnchor:[15,20],popupAnchor:[0,-30]}}),c=new b({iconUrl:"image/dead.png"}),d=defineCluster("dead");a.forEach(function(a){defineMarker(a,d,c)}),map.addLayer(d),a.forEach(function(a){a.dateParsed=parseDate(a.date),a.year=yearFormat(a.dateParsed),a.yearMonth=yearMonthFormat(a.dateParsed),a.death=+a.death});var e=(d3.nest().key(function(a){return a.year}).rollup(function(a){return d3.sum(a,function(a){return a.death})}).entries(a),d3.nest().key(function(a){return a.yearMonth}).rollup(function(a){return d3.sum(a,function(a){return a.death})}).entries(a)),f=d3.nest().key(function(a){return a.province}).rollup(function(a){return d3.sum(a,function(a){return a.death})}).entries(a),g={};f.forEach(function(a){g[a.key]=a.values}),console.log(g);var h=d3.select("body").select("#layer").append("svg").attr("with",canvasWidth).attr("height",canvasHeight);h.append("g").attr("class","bar").selectAll("rect").data(e).enter().append("rect").attr("class","death").attr("width",3).attr("height",function(a){return heightScale(a.values)}).attr("x",function(a,b){return 5*b+14}).attr("y",function(a){return 120-heightScale(a.values)}).append("title").text(function(a){return"时间: "+a.key+" , 死亡人数: "+a.values});var i=d3.scale.linear().domain([20,100,350]).range(["#aaa","#999","#111"]).interpolate(d3.interpolateHsl),j=d3.geo.mercator().center([108.9530982792,34.277799897831]).scale(250).translate([170,280]),k=d3.geo.path().projection(j),l=[0,1,2,3],m=d3.scale.ordinal().range(["#aaa","#999","#555","#111"]);d3.json("data/china.json",function(a){h.append("g").selectAll("path").data(a.features).enter().append("path").attr("stroke","none").attr("stroke","#ededed").attr("stroke-width",1).attr("d",k).style("fill",function(a){return g[a.properties.name]?i(g[a.properties.name]):"#ededed"}).append("title").text(function(a){return g[a.properties.name]?a.properties.name+", 死亡人数: "+g[a.properties.name]+"人":a.properties.name+", 死亡人数: 0人"}),h.append("g").attr("id","legend").attr("transform","translate(275, 340)"),d3.select("#legend").selectAll("rect.legends").data(l).enter().append("rect").attr("class","legends").attr("width","5").attr("height","15").attr("fill",function(a,b){return m(b)}).attr("transform",function(a,b){return"translate(0, "+-16*b+")"}),h.select("#legend").append("text").attr("transform","translate(-15, 15)").text("20").style("fill","#111").style("font-size","10px").style("font-family","SimHei, STHeiti, Arial, sans-serif"),h.select("#legend").append("text").attr("transform","translate(-20, -40)").text("350").style("fill","#111").style("font-size","10px").style("font-family","SimHei, STHeiti, Arial, sans-serif"),h.append("g").attr("id","footnote").attr("transform","translate(20, 430)").append("text").text("数据来源：国家安全生产监督管理总局").style("fill","#999").style("font-size","10px").style("font-family","SimHei, STHeiti, Arial, sans-serif")})});