function defineCluster(a){var b={};return b.maxClusterRadius=100,b.iconCreateFunction=function(b){var c=b.getChildCount(),d=a;return d+=10>c?"-small":30>c?"-medium":"-large",new L.DivIcon({html:"<div><span>"+c+"</span></div>",className:"marker-cluster "+d,iconSize:new L.Point(40,40)})},L.markerClusterGroup(b)}function defineMarker(a,b,c){var d="<b>事故时间</b>："+a.date+"<br><b>事故地点</b>："+a.place+"<br><b>死亡人数</b>："+a.death+"<br><b>事故原因</b>："+a.desc,e=L.marker(new L.LatLng(a.lat,a.lng),{title:d,icon:c});e.bindPopup(d),b.addLayer(e)}var viewCenter=[34.277799897831,100.9530982792],mapScale=5,minZoom=3,maxZoom=13,mapStyle="http://{s}.tile.osm.org/{z}/{x}/{y}.png",mapAttribution='&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',map=L.map("map").setView(viewCenter,mapScale);L.tileLayer(mapStyle,{attribution:mapAttribution,maxZoom:maxZoom,minZoom:minZoom}).addTo(map);var canvasWidth=300,canvasHeight=560,parseDate=d3.time.format("%Y-%m-%d").parse,yearFormat=d3.time.format("%Y"),yearMonthFormat=d3.time.format("%Y-%m"),heightScale=d3.scale.linear().domain([0,300]).range([0,100]),widthScale=d3.scale.linear().domain([0,60]).range([0,300]);d3.csv("data/geo_disaster.csv",function(a){var b=L.Icon.extend({options:{iconSize:[30,40],iconAnchor:[15,20],popupAnchor:[0,-30]}}),c=new b({iconUrl:"image/dead.png"}),d=defineCluster("dead");a.forEach(function(a){defineMarker(a,d,c)}),map.addLayer(d),a.forEach(function(a){a.dateParsed=parseDate(a.date),a.year=yearFormat(a.dateParsed),a.yearMonth=yearMonthFormat(a.dateParsed),a.death=+a.death});var e=(d3.nest().key(function(a){return a.year}).rollup(function(a){return d3.sum(a,function(a){return a.death})}).entries(a),d3.nest().key(function(a){return a.yearMonth}).rollup(function(a){return d3.sum(a,function(a){return a.death})}).entries(a)),f=d3.nest().key(function(a){return a.province}).rollup(function(a){return a.length}).entries(a);console.log(f);var g=d3.nest().key(function(a){return a.province}).rollup(function(a){return d3.sum(a,function(a){return a.death})}).entries(a),h={};g.forEach(function(a){h[a.key]=a.values});var i=d3.select("body").select("#layer").append("svg").attr("with",canvasWidth).attr("height",canvasHeight),j=i.append("g").attr("id","ball").attr("transform","translate(50,20)"),k=[5,239,3924],l=["年","次","人"];j.append("g").selectAll("circle.ball_circle").data(k).enter().append("circle").attr("class","ball_circle").attr("cx",function(a,b){return 100*b}).attr("cy",50).attr("r",40).attr("fill","#EA2D31"),j.append("g").selectAll("text.ball_text").data(k).enter().append("text").attr("class","ball_text").attr("text-anchor","middle").attr("x",function(a,b){return 100*b}).attr("y",55).attr("fill","#fff").attr("font-family","Arial Narrow").attr("font-size",28).attr("font-weight",800).text(function(a){return a}),j.append("g").selectAll("text.ball_text_cmt").data(l).enter().append("text").attr("class","ball_text_cmt").attr("text-anchor","middle").attr("x",function(a,b){return 100*b}).attr("y",75).attr("fill","#fff").attr("font-family","Microsoft Hahei").attr("font-size",14).attr("font-weight",800).text(function(a){return a});var m=i.append("g").attr("id","barChart").attr("transform","translate(20,80)"),n=(d3.extent(a,function(a){return a.dateParsed}),m.append("g").attr("id","xAxisBarChart").attr("class","axis").attr("transform","translate(0,120)")),o=d3.time.format.multi([["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]]),p=d3.time.scale().domain([new Date(2011,1,1),new Date(2015,5,30)]).range([0,263]),q=d3.svg.axis().scale(p).orient("bottom").tickFormat(o).ticks(d3.time.year,1);n.call(q),m.selectAll("rect").data(e).enter().append("rect").attr("class","death").attr("width",4).attr("height",function(a){return heightScale(a.values)}).attr("x",function(a,b){return 5*b}).attr("y",function(a){return 120-heightScale(a.values)}).append("title").text(function(a){return"时间: "+a.key+" , 死亡人数: "+a.values});var r=i.append("g").attr("id","mapChart").attr("transform","translate(0,70)"),s=d3.scale.linear().domain([20,100,350]).range(["#aaa","#999","#111"]).interpolate(d3.interpolateHsl),t=d3.geo.mercator().center([108.9530982792,34.277799897831]).scale(250).translate([170,280]),u=d3.geo.path().projection(t),v=[0,1,2,3],w=d3.scale.ordinal().range(["#aaa","#999","#555","#111"]);d3.json("data/china.json",function(a){var b=d3.select("body").append("div").attr("class","tooltipMap").style("opacity",0);r.append("g").selectAll("path").data(a.features).enter().append("path").attr("stroke","#ededed").attr("stroke-width",1).attr("d",u).style("fill",function(a){return h[a.properties.name]?s(h[a.properties.name]):"#ededed"}).on("mouseover",function(a){b.style("opacity",.8).style("z-index",10),h[a.properties.name]?b.html("<div class=provinceName>"+a.properties.name+"</div>5年死亡总数: "+h[a.properties.name]+"人").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-20+"px"):b.html("<div class=provinceName>"+a.properties.name+"</div>5年死亡总数: 0人").style("left",d3.event.pageX+"px").style("top",d3.event.pageY-20+"px")}),r.on("mouseout",function(a){return b.style("opacity",0)}),i.append("g").attr("id","legend").attr("transform","translate(275, 400)"),d3.select("#legend").selectAll("rect.legends").data(v).enter().append("rect").attr("class","legends").attr("width","5").attr("height","15").attr("fill",function(a,b){return w(b)}).attr("transform",function(a,b){return"translate(0, "+-16*b+")"}),i.select("#legend").append("text").attr("transform","translate(-15, 15)").text("20").style("fill","#111").style("font-size","10px").style("font-family","SimHei, STHeiti, Arial, sans-serif"),i.select("#legend").append("text").attr("transform","translate(-20, -40)").text("350").style("fill","#111").style("font-size","10px").style("font-family","SimHei, STHeiti, Arial, sans-serif"),i.append("g").attr("id","footnote").attr("transform","translate(15, 445)").append("text").text("数据来源：国家安全生产监督管理总局").style("fill","#999").style("font-size","10px").style("font-family","SimHei, STHeiti, Arial, sans-serif")})});